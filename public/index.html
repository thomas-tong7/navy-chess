const socket = io();
var board = null;
var game = new Chess();

// 1. DETERMINE PLAYER COLOR FROM URL
const path = window.location.pathname;
const playerColor = path.includes('black') ? 'b' : 'w';

// Update status to show who you are
document.getElementById('status').innerText = `You are playing as ${playerColor === 'w' ? 'White' : 'Black'}`;

function onDragStart (source, piece, position, orientation) {
    if (game.game_over()) return false;

    // 2. ONLY ALLOW PLAYER TO MOVE THEIR OWN COLOR
    if ((playerColor === 'w' && piece.search(/^b/) !== -1) ||
        (playerColor === 'b' && piece.search(/^w/) !== -1)) {
        return false;
    }
    
    // Also prevent moving if it's not your turn
    if ((game.turn() === 'w' && playerColor === 'b') ||
        (game.turn() === 'b' && playerColor === 'w')) {
        return false;
    }
}

function onDrop (source, target) {
    var move = game.move({ from: source, to: target, promotion: 'q' });
    if (move === null) return 'snapback';

    socket.emit('move', move);
    updateStatus();
    startTimer();
}

socket.on('move', function(move) {
    game.move(move);
    board.position(game.fen());
    updateStatus();
    startTimer();
});

// ... (Keep your Timer functions the same as before) ...

// 3. INITIALIZE BOARD WITH AUTO-FLIP
board = ChessBoard('myBoard', {
    draggable: true,
    position: 'start',
    orientation: playerColor === 'w' ? 'white' : 'black', // Auto-flips for black!
    onDragStart: onDragStart,
    onDrop: onDrop,
    pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
});
