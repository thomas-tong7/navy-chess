<!DOCTYPE html>
<html>
<head>
    <title>Navy Chess Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        :root { --navy-dark: #001e43; --navy-light: #003366; --accent: #00a8ff; --pale-blue: #a2c2e1; --dark-blue: #2e5a88; }
        
        body { 
            background-color: var(--navy-dark); color: white; font-family: -apple-system, sans-serif; 
            display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; 
            overflow: hidden; height: 100vh; justify-content: center;
        }

        .white-1e1d7 { background-color: var(--pale-blue) !important; } 
        .black-3c403 { background-color: var(--dark-blue) !important; }
        .highlight-move { box-shadow: inset 0 0 3px 3px rgba(0, 0, 0, .2); border-radius: 50%; width: 20px; height: 20px; margin: 30%; background: rgba(0,0,0,0.2); }

        #myBoard { width: 90vw; max-width: 400px; border: 4px solid #1e3a5f; border-radius: 8px; }
        
        .info-panel { 
            background: #002d62; padding: 15px; border-radius: 12px; 
            margin-top: 15px; width: 90vw; max-width: 400px; display: flex; 
            justify-content: space-between; box-sizing: border-box; border: 1px solid #1e3a5f;
            position: relative;
        }
        .timer { font-size: 24px; font-weight: bold; font-family: monospace; color: var(--accent); }

        .concede-btn {
            background: #ff4757; color: white; border: none; padding: 5px 10px;
            font-size: 12px; font-weight: bold; border-radius: 4px; cursor: pointer;
            margin-top: 5px;
        }

        #overlay, #winOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 30, 67, 0.98);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; text-align: center;
        }
        #winOverlay { display: none; }
        .card { background: #002d62; padding: 30px; border-radius: 20px; border: 2px solid var(--accent); width: 80%; max-width: 300px; }
        .btn { 
            background: var(--accent); color: white; border: none; padding: 12px 20px; 
            font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer; margin: 10px 0; width: 100%;
        }
    </style>
</head>
<body>

    <div id="overlay">
        <div class="card" id="setupCard">
            <h2 style="margin-top:0">Match Settings</h2>
            <p id="waitMsg">Waiting for White to pick time...</p>
            <div id="whiteControls" style="display:none">
                <button class="btn" onclick="setTime(600)">10 Mins Each</button>
                <button class="btn" onclick="setTime(300)">5 Mins Each</button>
            </div>
        </div>
    </div>

    <div id="winOverlay">
        <div class="card">
            <h1 id="winMessage">WHITE WINS!</h1>
            <p id="winReason" style="color: #81a1c1;">Checkmate</p>
            <button class="btn" onclick="requestRematch()">RE-MATCH</button>
        </div>
    </div>

    <h2 style="margin: 0 0 10px 0; letter-spacing: 2px;">NAVY CHESS</h2>
    
    <div id="myBoard"></div>

    <div class="info-panel">
        <div>
            WHITE <div id="whiteTimer" class="timer">10:00</div>
            <button id="whiteConcede" class="concede-btn" onclick="concede('w')" style="display:none">CONCEDE</button>
        </div>
        <div>
            <div style="text-align: right;">
                BLACK <div id="blackTimer" class="timer">10:00</div>
                <button id="blackConcede" class="concede-btn" onclick="concede('b')" style="display:none">CONCEDE</button>
            </div>
        </div>
    </div>

    <p id="status">Connecting...</p>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
        const socket = io();
        var board = null;
        var game = new Chess();
        const path = window.location.pathname;
        const playerColor = path.includes('black') ? 'b' : 'w';
        
        var whiteTime = 600, blackTime = 600;
        var timerInterval = null;

        // Show specific concede button
        if(playerColor === 'w') document.getElementById('whiteConcede').style.display = 'block';
        else document.getElementById('blackConcede').style.display = 'block';

        if(playerColor === 'w') {
            document.getElementById('whiteControls').style.display = 'block';
            document.getElementById('waitMsg').style.display = 'none';
        }

        function setTime(seconds) { socket.emit('set-time', seconds); }

        socket.on('apply-time', (seconds) => {
            whiteTime = seconds; blackTime = seconds;
            updateTimerDisplay('whiteTimer', seconds);
            updateTimerDisplay('blackTimer', seconds);
            document.getElementById('overlay').style.display = 'none';
        });

        function concede(color) {
            if(confirm("Are you sure you want to concede the match?")) {
                socket.emit('concede', color);
            }
        }

        socket.on('player-conceded', (concededColor) => {
            const winner = concededColor === 'w' ? "BLACK WINS!" : "WHITE WINS!";
            showVictory(winner, "Opponent Conceded");
        });

        function removeHighlights() { $('#myBoard .square-55d63').children('.highlight-move').remove(); }
        function highlightSquare(square) { $('#myBoard .square-' + square).append('<div class="highlight-move"></div>'); }

        function onMouseoverSquare (square, piece) {
            if (!piece || piece.search(playerColor) === -1 || game.turn() !== playerColor) return;
            var moves = game.moves({ square: square, verbose: true });
            if (moves.length === 0) return;
            for (var i = 0; i < moves.length; i++) highlightSquare(moves[i].to);
        }

        function onMouseoutSquare () { removeHighlights(); }

        function onDragStart (source, piece) {
            if (game.game_over() || piece.search(playerColor) === -1 || game.turn() !== playerColor) return false;
        }

        function onDrop (source, target) {
            var move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            removeHighlights();
            socket.emit('move', move);
            checkGameOver();
            startTimer();
            updateStatus();
        }

        socket.on('move', function(move) {
            game.move(move);
            board.position(game.fen());
            checkGameOver();
            startTimer();
            updateStatus();
        });

        function requestRematch() { socket.emit('rematch-request'); }

        socket.on('rematch-reset', function() {
            game.reset();
            board.start();
            document.getElementById('winOverlay').style.display = 'none';
            document.getElementById('overlay').style.display = 'flex';
            if (timerInterval) clearInterval(timerInterval);
        });

        function showVictory(msg, reason) {
            document.getElementById('winMessage').innerText = msg;
            document.getElementById('winReason').innerText = reason;
            document.getElementById('winOverlay').style.display = 'flex';
            clearInterval(timerInterval);
        }

        function checkGameOver() {
            if (game.game_over()) {
                let msg = game.in_checkmate() ? (game.turn() === 'w' ? "BLACK WINS!" : "WHITE WINS!") : "DRAW!";
                showVictory(msg, game.in_checkmate() ? "Checkmate" : "Stalemate/Draw");
            } else if (whiteTime <= 0 || blackTime <= 0) {
                let msg = whiteTime <= 0 ? "BLACK WINS!" : "WHITE WINS!";
                showVictory(msg, "Out of Time");
            }
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (game.turn() === 'w') whiteTime--; else blackTime--;
                updateTimerDisplay('whiteTimer', whiteTime);
                updateTimerDisplay('blackTimer', blackTime);
                if (whiteTime <= 0 || blackTime <= 0) checkGameOver();
            }, 1000);
        }

        function updateTimerDisplay(id, time) {
            let mins = Math.floor(Math.max(0, time) / 60);
            let secs = Math.max(0, time) % 60;
            document.getElementById(id).innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function updateStatus() {
            const turn = game.turn() === 'w' ? "White's Turn" : "Black's Turn";
            document.getElementById('status').innerText = `${turn} | Playing as ${playerColor === 'w' ? 'White' : 'Black'}`;
        }

        board = ChessBoard('myBoard', {
            draggable: true,
            position: 'start',
            orientation: playerColor === 'w' ? 'white' : 'black',
            onDragStart: onDragStart,
            onDrop: onDrop,
            onMouseoverSquare: onMouseoverSquare,
            onMouseoutSquare: onMouseoutSquare,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });
    </script>
</body>
</html>
